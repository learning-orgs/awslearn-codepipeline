version: 0.2

phases:
  install:
    commands:
      - echo "Updating the system..."
      - yum update -y  # Update system packages

      - echo "Installing Java 17..."
      - yum install -y java-17-amazon-corretto-devel  # Install Java 17
      - export JAVA_HOME=/usr/lib/jvm/java-17-amazon-corretto
      - export PATH=$JAVA_HOME/bin:$PATH
      - echo "Java version:"
      - java -version  # Verify Java version

      - echo "Installing Maven 3.x..."
      - yum install -y maven  # Install Maven 3.x using the standard Amazon Linux package
      - export M2_HOME=/usr/share/maven
      - export PATH=$M2_HOME/bin:$PATH
      - echo "Maven version:"
      - mvn -version || { echo 'mvn installation failed'; exit 1; }  # Validate Maven installation

  pre_build:
    commands:
      - echo "Setting JAVA_HOME and PATH for pre-build phase..."
      - export JAVA_HOME=/usr/lib/jvm/java-17-amazon-corretto
      - export PATH=$JAVA_HOME/bin:$PATH
      - echo "Running pre-build commands..."
      - mvn clean || { echo 'mvn clean failed'; exit 1; }  # Clean the project

  build:
    commands:
      - echo "Setting JAVA_HOME and PATH for build phase..."
      - export JAVA_HOME=/usr/lib/jvm/java-17-amazon-corretto
      - export PATH=$JAVA_HOME/bin:$PATH
      - echo "Building the project with Maven..."
      - mvn package -DskipTests || { echo 'mvn package failed'; exit 1; }  # Build the project

  post_build:
    commands:
      - echo "Build completed. Preparing artifacts..."
      - mkdir -p target/deploy
      - cp target/*.jar target/deploy/

artifacts:
  files:
    - target/deploy/**  # Include the compiled jar in the artifacts
  discard-paths: yes

cache:
  paths:
    - '/root/.m2/**/*'  # Cache Maven dependencies
